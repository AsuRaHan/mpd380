# Проект с датчиком давления МПД-380 Modbus RTU

Этот проект реализует связь с датчиком давления МПД-380, использующим протокол Modbus RTU через преобразователь RS485-TTL. Код разработан для микроконтроллера ESP32 и включает функциональность для чтения и интерпретации данных датчика, таких как давление, единицы измерения и настройки конфигурации. В этом README приведён обзор проекта, подробности из карты протокола Modbus RTU для МПД-380 и инструкции по установке и использованию.

## Обзор проекта

МПД-380 — это преобразователь давления, поддерживающий протокол Modbus RTU через интерфейс RS485. Проект использует ESP32 для чтения данных с датчика через простой преобразователь RS485-TTL (с выводами VCC, GND, TX, RX, A, B) и отображает результаты в Serial Monitor. Код обрабатывает сырые значения давления, преобразует их в понятные единицы (например, бары) и предоставляет диагностическую информацию.

### Возможности
- Чтение данных давления из регистра 0x0004.
- Получение настроек (адрес устройства, скорость передачи, единицы, десятичные знаки, смещение).
- Расчёт давления в заданных единицах датчика.
- Обработка ошибок Modbus с базовой диагностикой.
- Совместимость с простым преобразователем RS485-TTL без ручного управления DE/RE.

## Аппаратные требования
- **Плата разработки ESP32**: Любая модель с поддержкой UART2 (например, ESP32-WROOM-32).
- **Датчик давления МПД-380**: Настроен с адресом 1 и скоростью 9600 по умолчанию.
- **Преобразователь RS485-TTL**: Простой модуль с выводами VCC, GND, TX, RX, A, B, GND (например, на базе SP3485).
- **Подключение**:
  - A преобразователя → A датчика
  - B преобразователя → B датчика
  - GND преобразователя → GND датчика
  - TX преобразователя → GPIO16 (RX2) ESP32
  - RX преобразователя → GPIO17 (TX2) ESP32
  - VCC преобразователя → 3.3 В или 5 В ESP32 (проверь спецификацию модуля)
  - Питание датчика: 12–24 В (отдельно)
- **USB-кабель**: Для программирования и Serial Monitor.

## Программные требования
- **Arduino IDE**: С установленной поддержкой плат ESP32 (через Boards Manager, поиск "esp32").
- **Библиотека ModbusMaster**: Установить через Library Manager (поиск "ModbusMaster" от Doc Walker).
- **Терминал**: Для тестирования с ПК (например, Hercules или Tera Term).

## Подробности протокола Modbus RTU (на основе карты протоколов МПД-380)

Датчик МПД-380 использует протокол Modbus RTU через RS485 с следующими характеристиками:

### Общие настройки
- **Протокол**: Modbus RTU, полудуплексный RS485.
- **Настройки последовательного порта**: 9600 бод, 8 бит данных, без паритета, 1 стоп-бит (8N1). Поддерживаемые скорости: 1200, 2400, 4800, 9600, 19200, 38400, 57600, 115200.
- **Полином CRC**: 0xA001.
- **Формат данных**: Целочисленные со знаком 16 бит (-32768 до 32767). Значения с плавающей точкой требуют корректировки по десятичным знакам (регистр 0x0003).

### Форматы команд
1. **Команда чтения (функция 0x03)**:
   - Запрос: `[Адрес устройства] [0x03] [Старший байт адреса] [Младший байт адреса] [Старший байт количества] [Младший байт количества] [CRC16 младший] [CRC16 старший]`
     - Пример: `01 03 00 04 00 01 C4 0B` (чтение регистра 0x0004, 1 слово).
   - Ответ: `[Адрес устройства] [0x03] [Количество байт] [Старший байт данных] [Младший байт данных] [CRC16 младший] [CRC16 старший]`
     - Пример: `01 03 02 00 12 79 84` (данные 0x0012 = 18).

2. **Команда записи (функция 0x06)**:
   - Запрос: `[Адрес устройства] [0x06] [Старший байт адреса] [Младший байт адреса] [Старший байт данных] [Младший байт данных] [CRC16 младший] [CRC16 старший]`
     - Пример: `01 06 00 00 00 02 08 0B` (установка адреса 2).
   - Ответ: То же, что запрос, если успешно.

3. **Ответ об ошибке**:
   - `[Адрес устройства] [0x80 + Функция] [Код исключения] [CRC16 младший] [CRC16 старший]`
     - Коды исключений: 0x01 (недопустимая функция), 0x02 (недопустимый адрес), 0x03 (неверные данные).

### Карта регистров
| Адрес регистра | Количество | Байты | Диапазон данных  | Описание                              |
|-----------------|------------|-------|------------------|---------------------------------------|
| 0x0000         | 1          | 2     | 1–255            | Адрес устройства                      |
| 0x0001         | 1          | 2     | 0–7              | Скорость (0=1200, 3=9600, 7=115200)   |
| 0x0002         | 1          | 2     | 0–9              | Единицы (3=бар, 6=Psi и т.д.)         |
| 0x0003         | 1          | 2     | 0–4              | Десятичные знаки (0=целое, 2=0.01)    |
| 0x0004         | 1          | 2     | -32768–32767     | Сырое значение давления               |
| 0x0005         | 1          | 2     | -32768–32767     | Нулевой диапазон (минимум давления)   |
| 0x0006         | 1          | 2     | -32768–32767     | Полный диапазон (максимум, например, 400) |
| 0x000C         | 1          | 2     | -32768–32767     | Смещение (обычно 0)                   |
| 0x000F         | 1          | 2     | 0                | Сохранение в пользовательские настройки |
| 0x0010         | 1          | 2     | 1                | Восстановление заводских настроек     |

- **Расчёт давления**: `давление = (сырое_значение + смещение) / 10^десятичные_знаки`.
- **Ограничения для пользователя**: Изменять можно только адрес (0x0000), скорость (0x0001) и смещение (0x000C) без специализированного ПО от производителя.

### Примечания
- Данные передаются как сырые 16-битные целые со знаком. Для значений с плавающей точкой (например, 6.000) читайте десятичные знаки и делите соответственно.
- Изменения адреса или скорости вступают в силу после ответа.
- Сброс на заводские настройки (0x0010) может потребовать повторного обнаружения датчика.

## Установка

1. **Установите Arduino IDE** и добавьте поддержку ESP32 (через Boards Manager, поиск "esp32").
2. **Установите библиотеку ModbusMaster**:
   - Откройте Arduino IDE, перейдите в Sketch > Include Library > Manage Libraries.
   - Найдите "ModbusMaster" и установите.
3. **Подключите оборудование** как указано выше.
4. **Загрузите скетч**:
   - Откройте `mpd380.ino` в Arduino IDE.
   - Выберите плату ESP32 и порт.
   - Загрузите код.

## Использование

1. **Откройте Serial Monitor**:
   - Установите скорость 115200.
   - Вы увидите вывод, например:
2. **Тестирование датчика**:
   - Подайте давление на датчик.
   - Значение давления должно увеличиться (например, 0.22 бар).
3. **Обработка ошибок**:
   - Если возникает ошибка (например, `Ошибка Modbus: 0xE0 - Таймаут`), проверьте проводку, питание или скорость.

## Подробности скетча (`mpd380.ino`)

### Структура кода
- **Библиотеки**: Использует `ModbusMaster.h` для связи по Modbus RTU.
- **Определения пинов**:
- `RX_PIN = 16` (RX UART2).
- `TX_PIN = 17` (TX UART2).
- **Настройка**:
- Инициализирует Serial (115200) и Serial2 (9600, 8N1) для Modbus.
- Настраивает ModbusMaster с адресом 1.
- **Цикл**:
- Читает 13 регистров (0x0000–0x000C) каждые 500 мс.
- Извлекает адрес, код скорости, единицы, десятичные знаки, сырое давление и смещение.
- Рассчитывает давление и выводит результаты.
- Обрабатывает ошибки Modbus с кодами, такими как 0xE0 (таймаут), 0x83 (неверный адрес).

### Функции
- `getUnitString(uint8_t unit_code)`: Преобразует код единиц (0x0002) в строку (например, "бар" для 3).
- `getBaudRate(uint8_t baud_code)`: Преобразует код скорости (0x0001) в строку (например, "9600" для 3).

### Улучшения
- Объединяет все запросы регистров в один для повышения эффективности.
- Проверяет отрицательные значения давления и предупреждает, если они есть.
- Адаптирует формат вывода давления в зависимости от десятичных знаков.

## Устранение неполадок
- **Отсутствие данных**: Проверьте COM-порт, проводку A/B, соединение GND и питание датчика (12–24 В).
- **Неверные единицы**: Проверьте регистр 0x0002 (должно быть 3 для бар) и настройте, если нужно.
- **Ошибки**: Используйте коды ошибок в Serial Monitor для диагностики (например, 0xE0 = таймаут).

## Будущие улучшения
- Добавить поддержку записи в регистры (например, изменение адреса или скорости с функцией 0x06).
- Разработать приложение для ПК (например, на C++) для мониторинга давления в реальном времени.
- Добавить функции калибровки или ведения логов.

## Лицензия
Проект является открытым. Модифицируйте и распространяйте под лицензией MIT.

## Благодарности
- Документация основана на "Карта протокола Modbus RTU - МПД380.pdf", предоставленной инженером компании Мераприбор.